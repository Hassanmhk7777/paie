{% extends 'base.html' %}

{% block content %}
<!-- METS ICI le code du tableau employés, les filtres, etc -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Liste des employés</h4>
        <div class="d-flex">
            <input type="text" id="search-employee" class="form-control form-control-sm me-2" placeholder="Rechercher...">
            <select id="filter-site" class="form-select form-select-sm me-2">
                <option value="">Tous les sites</option>
                {% for s in sites %}
                    <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
            </select>
            <select id="filter-dept" class="form-select form-select-sm me-2">
                <option value="">Tous les départements</option>
                {% for d in departments %}
                    <option value="{{ d.id }}">{{ d.name }}</option>
                {% endfor %}
            </select>
            <button class="btn btn-primary btn-sm" id="btn-add" data-url="{% url 'employee_create' %}">➕ Ajouter</button>
        </div>
    </div>
    <div class="card-body" id="employee-table">
        {% include 'employees/includes/partial_employee_list.html' %}
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modal-employee" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content"></div>
    </div>
</div>

<script>
$(document).ready(function(){

    // Charger form (Add/Update)
    var loadForm = function() {
        var btn = $(this);
        $.ajax({
            url: btn.attr("data-url"),
            type: 'get',
            dataType: 'json',
            beforeSend: function() {
                $("#modal-employee").modal("show");
            },
            success: function(data) {
                $("#modal-employee .modal-content").html(data.html_form);
            }
        });
    };

    // Sauvegarder form
    var saveForm = function() {
        var form = $(this);
        $.ajax({
            url: form.attr("action"),
            data: form.serialize(),
            type: form.attr("method"),
            dataType: 'json',
            success: function(data) {
                if (data.form_is_valid) {
                    $("#employee-table").html(data.html_employee_list);
                    $("#modal-employee").modal("hide");
                } else {
                    $("#modal-employee .modal-content").html(data.html_form);
                }
            }
        });
        return false;
    };

    // Filtrage + Recherche
    function filterEmployees() {
        var site = $("#filter-site").val();
        var dept = $("#filter-dept").val();
        var search = $("#search-employee").val();
        $.ajax({
            url: "/employees/",
            data: {
                'site': site,
                'department': dept,
                'search': search
            },
            success: function(data) {
                $("#employee-table").html(data);
            }
        });
    }
    $("#filter-site, #filter-dept").change(filterEmployees);
    $("#search-employee").keyup(filterEmployees);

    // Events CRUD
    $("#btn-add").click(loadForm);
    $("#employee-table").on("click", ".js-update-employee", loadForm);
    $("#employee-table").on("click", ".js-delete-employee", loadForm);
    $("#modal-employee").on("submit", ".js-employee-form", saveForm);
});
</script>
{% endblock %}
