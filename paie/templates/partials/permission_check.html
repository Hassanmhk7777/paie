<!-- paie/templates/partials/permission_check.html -->
{% if has_permission %}
    <div class="permission-granted" data-permission="{{ permission_name }}">
        <!-- Le contenu sera affiché ici si la permission est accordée -->
        {{ block.super }}
    </div>
{% else %}
    <!-- Optionnel: Affichage pour permission refusée -->
    {% if user.is_authenticated %}
        <div class="permission-denied d-none" data-permission="{{ permission_name }}" data-role="{{ user_role }}">
            <small class="text-muted">
                <i class="fas fa-lock me-1"></i>
                Permission requise: {{ permission_name }}
            </small>
        </div>
    {% endif %}
{% endif %}

<!-- paie/templates/partials/sidebar_menu.html -->
<div class="sidebar-menu" data-role="{{ user_profile.role }}">
    <div class="user-info mb-3">
        <div class="d-flex align-items-center p-3 bg-light rounded">
            <img src="{{ user_profile.avatar.url|default:'/static/img/default-avatar.png' }}" 
                 alt="Avatar" class="rounded-circle me-3" width="40" height="40">
            <div>
                <div class="fw-bold">{{ user_profile.user.get_full_name|default:user_profile.user.username }}</div>
                <small class="text-muted">{{ user_profile.get_role_display }}</small>
            </div>
        </div>
    </div>

    <ul class="nav flex-column">
        {% for item in menu_items %}
        <li class="nav-item">
            <a class="nav-link {% if item.active %}active{% endif %} d-flex align-items-center justify-content-between"
               href="{{ item.url }}" 
               {% if item.confirm %}onclick="return confirm('{{ item.confirm }}')"{% endif %}>
                <span>
                    <i class="{{ item.icon }} me-2"></i>
                    {{ item.label }}
                </span>
                {% if item.badge %}
                    <span class="badge {{ item.badge_class|default:'bg-primary' }} ms-2">{{ item.badge }}</span>
                {% endif %}
            </a>
            
            {% if item.submenu %}
            <ul class="nav flex-column ms-3">
                {% for subitem in item.submenu %}
                    {% load permission_tags %}
                    {% if not subitem.permission or user|user_can:subitem.permission %}
                    <li class="nav-item">
                        <a class="nav-link nav-link-sm" href="{{ subitem.url }}">
                            <i class="fas fa-chevron-right fa-xs me-2"></i>
                            {{ subitem.label }}
                        </a>
                    </li>
                    {% endif %}
                {% endfor %}
            </ul>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
</div>

<!-- paie/templates/partials/user_header.html -->
<div class="user-header d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
        <img src="{{ avatar_url }}" alt="Avatar" class="rounded-circle me-3" width="40" height="40">
        <div>
            <div class="fw-bold">{{ full_name }}</div>
            <small class="text-muted">
                <span class="badge {{ role_class }}">{{ role_display }}</span>
                {% if employee %}
                    - {{ employee.department.nom|default:"Aucun département" }}
                {% endif %}
            </small>
        </div>
    </div>
    
    <div class="user-actions d-flex align-items-center gap-2">
        <!-- Notifications -->
        {% if notifications_count > 0 %}
        <div class="dropdown">
            <button class="btn btn-link position-relative" data-bs-toggle="dropdown">
                <i class="fas fa-bell"></i>
                {% if notifications_count > 0 %}
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        {{ notifications_count }}
                        <span class="visually-hidden">notifications non lues</span>
                    </span>
                {% endif %}
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><h6 class="dropdown-header">Notifications</h6></li>
                <li><a class="dropdown-item" href="#">
                    <i class="fas fa-info-circle text-info me-2"></i>
                    Nouvelle demande de congé
                </a></li>
                <li><a class="dropdown-item" href="#">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    Paie validée pour Mars 2025
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-center" href="#">Voir tout</a></li>
            </ul>
        </div>
        {% endif %}
        
        <!-- Menu utilisateur -->
        <div class="dropdown">
            <button class="btn btn-link" data-bs-toggle="dropdown">
                <i class="fas fa-user-cog"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><h6 class="dropdown-header">{{ full_name }}</h6></li>
                <li><a class="dropdown-item" href="{% url 'paie:profile' %}">
                    <i class="fas fa-user me-2"></i>Mon Profil
                </a></li>
                <li><a class="dropdown-item" href="#">
                    <i class="fas fa-cog me-2"></i>Préférences
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="{% url 'paie:logout' %}">
                    <i class="fas fa-sign-out-alt me-2"></i>Se déconnecter
                </a></li>
            </ul>
        </div>
    </div>
</div>

<!-- paie/templates/partials/action_button.html -->
{% if has_permission %}
    <a href="{{ url }}" 
       class="btn {{ css_class }} btn-sm"
       {% if confirm %}onclick="return confirm('{{ confirm }}')"{% endif %}
       data-permission="{{ permission }}">
        {% if icon %}
            <i class="{{ icon }} me-1"></i>
        {% endif %}
        {{ label }}
    </a>
{% else %}
    <span class="btn btn-secondary btn-sm disabled" 
          title="Permission requise: {{ permission }}"
          data-bs-toggle="tooltip">
        {% if icon %}
            <i class="{{ icon }} me-1"></i>
        {% endif %}
        {{ label }}
    </span>
{% endif %}

<!-- paie/templates/partials/conditional_content.html -->
{% if has_permission %}
    {% include content_template %}
{% else %}
    <div class="alert alert-warning" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Vous n'avez pas les permissions nécessaires pour voir ce contenu.
    </div>
{% endif %}

<!-- paie/templates/partials/permission_denied_modal.html -->
<div class="modal fade" id="permissionDeniedModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Accès refusé
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Vous n'avez pas les permissions nécessaires pour effectuer cette action.</p>
                <div class="alert alert-info">
                    <strong>Votre rôle actuel:</strong> 
                    <span class="badge bg-info ms-2">{{ user_profile.get_role_display }}</span>
                </div>
                <p><small class="text-muted">
                    Si vous pensez que c'est une erreur, contactez votre administrateur système.
                </small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Fermer
                </button>
                {% if user_profile.is_employe %}
                <a href="{% url 'paie:employee_dashboard' %}" class="btn btn-primary">
                    Retour à mon espace
                </a>
                {% elif user_profile.is_rh %}
                <a href="{% url 'paie:rh_dashboard' %}" class="btn btn-primary">
                    Retour au dashboard RH
                </a>
                {% elif user_profile.is_admin %}
                <a href="{% url 'paie:admin_dashboard' %}" class="btn btn-primary">
                    Retour au dashboard Admin
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- paie/templates/partials/role_badge.html -->
{% load permission_tags %}

<div class="role-indicator">
    {% if user|is_admin %}
        <span class="badge bg-danger">
            <i class="fas fa-crown me-1"></i>
            Administrateur
        </span>
    {% elif user|is_rh %}
        <span class="badge bg-warning">
            <i class="fas fa-users me-1"></i>
            Ressources Humaines
        </span>
    {% elif user|is_employee %}
        <span class="badge bg-info">
            <i class="fas fa-user me-1"></i>
            Employé
        </span>
    {% else %}
        <span class="badge bg-secondary">
            <i class="fas fa-question me-1"></i>
            Rôle inconnu
        </span>
    {% endif %}
</div>

<!-- paie/templates/partials/data_table_actions.html -->
{% load permission_tags %}

<div class="table-actions d-flex gap-1">
    <!-- Voir détails (toujours autorisé si on peut voir l'objet) -->
    <a href="{{ object.get_absolute_url }}" 
       class="btn btn-outline-primary btn-sm"
       title="Voir les détails">
        <i class="fas fa-eye"></i>
    </a>
    
    <!-- Modifier (selon permission) -->
    {% action_button 'edit_employees' 'Modifier' object.get_edit_url 'fas fa-edit' 'btn-outline-warning' %}
    
    <!-- Supprimer (selon permission) -->
    {% action_button 'delete_employees' 'Supprimer' object.get_delete_url 'fas fa-trash' 'btn-outline-danger' 'Êtes-vous sûr de vouloir supprimer cet élément ?' %}
</div>

<!-- paie/templates/partials/stats_cards.html -->
{% load permission_tags %}

<div class="row">
    <!-- Carte Employés -->
    {% if user|user_can:'view_all_employees' %}
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ stats.total_employees|default:0 }}</h4>
                        <p class="mb-0">Employés</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Carte Congés en attente -->
    {% if user|user_can:'approve_leaves' %}
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ stats.pending_leaves|default:0 }}</h4>
                        <p class="mb-0">Congés à valider</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Carte Paies -->
    {% if user|user_can:'view_all_payroll' %}
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ stats.active_payrolls|default:0 }}</h4>
                        <p class="mb-0">Paies actives</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calculator fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Carte spécifique employé -->
    {% if user|is_employee and user.profile.employee %}
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ stats.remaining_leaves|default:0 }}</h4>
                        <p class="mb-0">Jours de congés</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-umbrella-beach fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- paie/templates/partials/breadcrumb.html -->
{% load permission_tags %}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            {% if user|is_admin %}
                <a href="{% url 'paie:admin_dashboard' %}">
                    <i class="fas fa-tachometer-alt me-1"></i>Dashboard Admin
                </a>
            {% elif user|is_rh %}
                <a href="{% url 'paie:rh_dashboard' %}">
                    <i class="fas fa-chart-line me-1"></i>Dashboard RH
                </a>
            {% else %}
                <a href="{% url 'paie:employee_dashboard' %}">
                    <i class="fas fa-home me-1"></i>Mon Espace
                </a>
            {% endif %}
        </li>
        
        {% for item in breadcrumb_items %}
        <li class="breadcrumb-item {% if forloop.last %}active{% endif %}">
            {% if not forloop.last %}
                <a href="{{ item.url }}">{{ item.label }}</a>
            {% else %}
                {{ item.label }}
            {% endif %}
        </li>
        {% endfor %}
    </ol>
</nav>

<!-- paie/templates/errors/permission_denied.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accès refusé - PaiePro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-body text-center p-5">
                        <div class="mb-4">
                            <i class="fas fa-lock fa-4x text-warning"></i>
                        </div>
                        
                        <h2 class="card-title text-danger mb-3">{{ error_title }}</h2>
                        <p class="card-text text-muted mb-4">{{ error_message }}</p>
                        
                        {% if user_role %}
                        <div class="alert alert-info">
                            <strong>Votre rôle actuel:</strong>
                            <span class="badge bg-info ms-2">{{ user_role }}</span>
                        </div>
                        {% endif %}
                        
                        {% if suggestions %}
                        <div class="mt-4">
                            <h6>Actions disponibles:</h6>
                            <div class="d-grid gap-2">
                                {% for suggestion in suggestions %}
                                <a href="{{ suggestion.url }}" class="btn btn-outline-primary">
                                    {{ suggestion.label }}
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="mt-4">
                            <small class="text-muted">
                                Si vous pensez qu'il s'agit d'une erreur, contactez votre administrateur système.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>